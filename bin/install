#!/usr/bin/env zsh

successfully() {
  $* || (echo "failed" 1>&2 && exit 1)
}

# Install Clang https://github.com/kennethreitz/osx-gcc-installer

echo "Installing Homebrew, a package manager for OS X..."

  echo "~> Setting permissions in /usr/local and ~/Library..."
  echo "   (You may need to enter your password.)"
  # Set permissions for Homebrew on /usr/local
  successfully sudo mkdir -p /usr/local
  successfully sudo chown -R `whoami` /usr/local
  
  # Set permissions for Homebrew in user directory.
  successfully sudo mkdir -p ~/Library/Caches/Homebrew
  successfully sudo chown -R `whoami` ~/Library/Caches/Homebrew
  successfully sudo mkdir -p ~/Library/Logs/Homebrew
  successfully sudo chown -R `whoami` ~/Library/Logs/Homebrew
  
  successfully ruby <(curl -fsS https://raw.github.com/mxcl/homebrew/go)
  successfully brew update

echo "Installing Ruby with RVM..."

  echo "~> Installing system libraries required for Ruby ..."
  successfully brew install autoconf automake libtool pkg-config libyaml readline libxml2 libxslt libksba openssl sqlite

  echo "~> Setting permissions on ~/.rvm ..."
  echo "   (You may need to enter your password.)"
  successfully sudo mkdir -p ~/.rvm
  successfully sudo chown -R `whoami` ~/.rvm

  echo "~> Installing RVM, the Ruby Version Manager... "
  successfully curl -#L https://get.rvm.io | bash -s stable --ruby
  
  echo "~> Getting RVM head... "
  successfully rvm get head --autolibs=0
  
  echo "~> Installing Ruby 2.0.0 using Clang ... "
  successfully rvm install 2.0.0 --with-gcc=clang

echo "Installing Nginx, a fast web server ... "

  successfully brew install nginx

echo "Installing MongoDB, a NoSQL database ..."

  successfully brew install mongodb

echo "Installing Redis, a key-value database ..."

  successfully brew install redis

echo "Installing Syme ..."

  successfully git clone git@github.com:louismullie/syme.git
  successfully cd syme
  successfully bundle install

echo "Starting Syme ..."

  # export rvmsudo_secure_path=1
  # rvmsudo bundle exec foreman export launchd /etc/launchd.conf -f ./Procfile -a syme -u `whoami` -l ./logs
  successfully foreman start